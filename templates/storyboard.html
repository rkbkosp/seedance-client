{{ template "header" . }}

<div class="mb-6">
    <a href="/"
        class="inline-flex items-center text-md-sys-color-primary hover:text-md-sys-color-primary/80 font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"
            class="mr-1">
            <path d="m313-440 224 224-57 56-320-320 320-320 57 56-224 224h487v80H313Z" />
        </svg>
        <span data-i18n="sb.back">Back to Projects</span>
    </a>
</div>

<div class="mb-10 p-6 bg-md-sys-color-surface-variant rounded-md3-xl">
    <h1 class="text-4xl font-normal text-md-sys-color-on-surface-variant mb-2">{{ .Project.Name }}</h1>
    <p class="text-md-sys-color-on-surface-variant opacity-80">Campaign ID: {{ .Project.ID }}</p>
</div>

<!-- Storyboard List -->
<div class="space-y-12">
    {{ range .Project.Storyboards }}
    <div class="bg-md-sys-color-surface rounded-md3-xl shadow-lg border border-md-sys-color-outline/10 overflow-hidden"
        id="sb-{{ .ID }}">
        <!-- Header -->
        <div
            class="px-8 py-5 border-b border-md-sys-color-surface-variant/50 flex justify-between items-center bg-md-sys-color-surface">
            <div class="flex items-center gap-4">
                <span class="text-lg font-medium text-md-sys-color-on-surface"><span
                        data-i18n="sb.scene">Storyboard</span> {{ .ID }}</span>
                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide 
                    {{ if eq .Status " Succeeded" }}bg-green-100 text-green-800 {{ else if eq .Status "Failed"
                    }}bg-red-100 text-red-800 {{ else if eq .Status "Running" }}bg-blue-100 text-blue-800 {{ else
                    }}bg-gray-200 text-gray-700{{ end }}">
                    {{ .Status }}
                </span>
            </div>
            <div class="flex items-center gap-2">
                <!-- Edit Button -->
                <button type="button"
                    onclick="openEditDialog({{ .ID }}, '{{ .Prompt }}', '{{ .ModelID }}', '{{ .Ratio }}', {{ .Duration }})"
                    class="text-md-sys-color-primary hover:bg-md-sys-color-primary/10 p-2 rounded-full transition"
                    title="Edit">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"
                        fill="currentColor">
                        <path
                            d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z" />
                    </svg>
                </button>
                <!-- Delete Button -->
                <form action="/storyboards/delete/{{ .ID }}" method="POST"
                    onsubmit="return confirm(window.i18n_data[getLanguage()]['sb.confirm_delete'] || 'Delete this storyboard?');">
                    <button type="submit"
                        class="text-md-sys-color-error hover:bg-md-sys-color-error/10 p-2 rounded-full transition">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"
                            fill="currentColor">
                            <path
                                d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <div class="flex flex-col md:flex-row">
            <!-- Left: Inputs & Config -->
            <div class="md:w-1/2 p-8 space-y-6">
                <div>
                    <h3 class="text-sm font-bold text-md-sys-color-primary mb-2 uppercase tracking-wider"
                        data-i18n="sb.prompt">Prompt</h3>
                    <p class="text-md-sys-color-on-surface text-lg leading-relaxed">{{ .Prompt }}</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    {{ if .FirstFramePath }}
                    <div class="relative group">
                        <label class="block text-xs font-bold text-md-sys-color-on-surface-variant mb-1 uppercase"
                            data-i18n="sb.first_frame">First Frame</label>
                        <div class="rounded-md3-md overflow-hidden border border-md-sys-color-outline/20">
                            <img src="/{{ .FirstFramePath }}" class="w-full h-32 object-cover">
                        </div>
                    </div>
                    {{ end }}
                    {{ if .LastFramePath }}
                    <div class="relative group">
                        <label class="block text-xs font-bold text-md-sys-color-on-surface-variant mb-1 uppercase"
                            data-i18n="sb.last_frame">Last Frame</label>
                        <div class="rounded-md3-md overflow-hidden border border-md-sys-color-outline/20">
                            <img src="/{{ .LastFramePath }}" class="w-full h-32 object-cover">
                        </div>
                    </div>
                    {{ end }}
                </div>

                <div class="flex flex-wrap gap-3 mt-4">
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-lg bg-md-sys-color-secondary-container text-md-sys-color-on-secondary-container text-xs font-medium">
                        {{ .ModelID }}
                    </span>
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-lg bg-md-sys-color-secondary-container text-md-sys-color-on-secondary-container text-xs font-medium">
                        {{ .Ratio }}
                    </span>
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-lg bg-md-sys-color-secondary-container text-md-sys-color-on-secondary-container text-xs font-medium">
                        {{ .Duration }}s
                    </span>
                </div>
            </div>

            <!-- Right: Media Output -->
            <div class="md:w-1/2 bg-black flex items-center justify-center relative min-h-[360px]">
                {{ if eq .Status "Succeeded" }}
                <video controls class="w-full h-full max-h-[500px] object-contain" loop>
                    <source src="{{ .VideoURL }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <!-- Floating Download Button -->
                <a href="{{ .VideoURL }}" download
                    class="absolute bottom-4 right-4 bg-md-sys-color-primary text-white p-3 rounded-full shadow-lg hover:bg-md-sys-color-primary/90 transition"
                    title="Download">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"
                        fill="currentColor">
                        <path
                            d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
                    </svg>
                </a>
                {{ else if eq .Status "Running" }}
                <div class="text-white flex flex-col items-center">
                    <div
                        class="w-12 h-12 border-4 border-md-sys-color-primary border-t-transparent rounded-full animate-spin mb-4">
                    </div>
                    <p class="font-medium tracking-wide" data-i18n="sb.generating">GENERATING SCENE...</p>
                </div>
                {{ else if eq .Status "Draft" }}
                <form action="/storyboards/{{ .ID }}/generate" method="POST" class="generate-form">
                    <button type="submit"
                        class="bg-md-sys-color-primary-container text-md-sys-color-on-primary-container px-8 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl hover:scale-105 transition transform flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"
                            fill="currentColor">
                            <path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z" />
                        </svg>
                        <span data-i18n="sb.start_gen">Generate Video</span>
                    </button>
                </form>
                {{ else }}
                <div class="text-md-sys-color-error flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48"
                        fill="currentColor">
                        <path
                            d="M480-280q17 0 28.5-11.5T520-320q0-17-11.5-28.5T480-360q-17 0-28.5 11.5T440-320q0 17 11.5 28.5T480-280Zm-40-160h80v-240h-80v240Zm40 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
                    </svg>
                    <p class="mt-2 font-bold" data-i18n="sb.failed">Generation Failed</p>
                    <!-- Retry Button -->
                    <form action="/storyboards/{{ .ID }}/generate" method="POST" class="generate-form mt-4">
                        <button type="submit"
                            class="bg-md-sys-color-error text-white px-6 py-2 rounded-full font-medium shadow-md hover:shadow-lg hover:scale-105 transition transform flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"
                                fill="currentColor">
                                <path
                                    d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                            </svg>
                            <span data-i18n="sb.retry">Retry</span>
                        </button>
                    </form>
                </div>
                {{ end }}
            </div>
        </div>
    </div>
    {{ end }}
</div>

<!-- Add New Storyboard Form (MD3 Card) -->
<div class="mt-16 bg-white rounded-md3-xl shadow-lg border border-md-sys-color-outline/20 p-8">
    <div class="flex items-center gap-3 mb-8">
        <div
            class="w-10 h-10 rounded-full bg-md-sys-color-primary-container flex items-center justify-center text-md-sys-color-on-primary-container">
            <span class="material-symbols-outlined text-2xl font-bold">+</span>
        </div>
        <h3 class="text-2xl font-normal text-md-sys-color-on-surface" data-i18n="sb.new">New Storyboard</h3>
    </div>

    <form action="/projects/{{ .Project.ID }}/storyboards" method="POST" enctype="multipart/form-data"
        class="space-y-8">
        <!-- Prompt Field -->
        <div class="relative">
            <label class="block text-sm font-medium text-md-sys-color-primary mb-2 ml-1"
                data-i18n="sb.prompt">Prompt</label>
            <textarea name="prompt" rows="3" required
                class="w-full bg-md-sys-color-surface-variant/30 border-b-2 border-md-sys-color-outline hover:border-md-sys-color-on-surface-variant focus:border-md-sys-color-primary rounded-t-lg px-4 py-3 outline-none transition-colors resize-none"
                data-i18n="sb.desc_placeholder" placeholder="Describe your scene in detail..."></textarea>
            <p class="text-xs text-md-sys-color-outline mt-1 ml-1" data-i18n="sb.desc_hint">Detailed descriptions yield
                better results.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- First Frame -->
            <div>
                <label class="block text-sm font-medium text-md-sys-color-on-surface-variant mb-2 ml-1"
                    data-i18n="sb.first_frame">First Frame (Start)</label>
                <div id="drop-first-frame"
                    class="drag-drop-zone relative bg-md-sys-color-surface-variant/30 rounded-lg border-2 border-dashed border-md-sys-color-outline p-6 text-center hover:bg-md-sys-color-primary/5 transition cursor-pointer">
                    <input type="file" id="input-first-frame" name="first_frame" accept="image/*"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="upload-placeholder text-md-sys-color-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32"
                            fill="currentColor" class="mx-auto mb-2">
                            <path
                                d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
                        </svg>
                        <span class="font-medium" data-i18n="sb.upload_img">Upload or Drop Image</span>
                    </div>
                    <img class="preview-img hidden w-full h-32 object-cover rounded">
                </div>
            </div>
            <!-- Last Frame -->
            <div>
                <label class="block text-sm font-medium text-md-sys-color-on-surface-variant mb-2 ml-1"
                    data-i18n="sb.last_frame">Last Frame (End)</label>
                <div id="drop-last-frame"
                    class="drag-drop-zone relative bg-md-sys-color-surface-variant/30 rounded-lg border-2 border-dashed border-md-sys-color-outline p-6 text-center hover:bg-md-sys-color-primary/5 transition cursor-pointer">
                    <input type="file" id="input-last-frame" name="last_frame" accept="image/*"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="upload-placeholder text-md-sys-color-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32"
                            fill="currentColor" class="mx-auto mb-2">
                            <path
                                d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
                        </svg>
                        <span class="font-medium" data-i18n="sb.upload_img">Upload or Drop Image</span>
                    </div>
                    <img class="preview-img hidden w-full h-32 object-cover rounded">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Model Selection -->
            <div class="bg-md-sys-color-surface-variant/30 rounded-t-lg border-b border-md-sys-color-outline px-4 py-2">
                <label class="block text-xs text-md-sys-color-primary mb-1" data-i18n="sb.model">Model</label>
                <select name="model_id"
                    class="w-full bg-transparent outline-none text-md-sys-color-on-surface font-medium py-1">
                    <option value="doubao-seedance-1-5-pro-251215">Seedance 1.5 Pro</option>
                    <option value="doubao-seedance-1-0-pro-fast-251015">Seedance 1.0 Pro Fast</option>
                </select>
            </div>
            <!-- Ratio -->
            <div class="bg-md-sys-color-surface-variant/30 rounded-t-lg border-b border-md-sys-color-outline px-4 py-2">
                <label class="block text-xs text-md-sys-color-primary mb-1" data-i18n="sb.ratio">Ratio</label>
                <select name="ratio"
                    class="w-full bg-transparent outline-none text-md-sys-color-on-surface font-medium py-1">
                    <option value="adaptive">Adaptive (Follow Image)</option>
                    <option value="16:9">16:9 (Landscape)</option>
                    <option value="9:16">9:16 (Portrait)</option>
                </select>
            </div>
            <!-- Duration -->
            <div class="bg-md-sys-color-surface-variant/30 rounded-t-lg border-b border-md-sys-color-outline px-4 py-2">
                <label class="block text-xs text-md-sys-color-primary mb-1" data-i18n="sb.duration">Duration</label>
                <select name="duration"
                    class="w-full bg-transparent outline-none text-md-sys-color-on-surface font-medium py-1">
                    <option value="5" selected>5s</option>
                    <option value="10">10s</option>
                </select>
            </div>
        </div>

        <div class="pt-6 flex justify-end">
            <button type="submit"
                class="md3-btn-filled text-lg px-8 py-3 rounded-full shadow-lg hover:shadow-xl transition transform hover:-translate-y-1"
                data-i18n="sb.add_btn">
                Add Storyboard
            </button>
        </div>
    </form>
</div>

<!-- Edit Storyboard Modal Dialog -->
<dialog id="edit-dialog" class="p-0 rounded-md3-xl shadow-2xl bg-transparent border-none w-full max-w-lg">
    <div class="bg-md-sys-color-surface p-6 rounded-md3-xl">
        <h3 class="text-2xl font-normal text-md-sys-color-on-surface mb-4" data-i18n="sb.edit_title">Edit Storyboard
        </h3>

        <form id="edit-form" method="POST" enctype="multipart/form-data" class="space-y-6">
            <!-- Prompt -->
            <div>
                <label class="block text-sm font-medium text-md-sys-color-primary mb-2"
                    data-i18n="sb.prompt">Prompt</label>
                <textarea id="edit-prompt" name="prompt" rows="3" required
                    class="w-full bg-md-sys-color-surface-variant/30 border-b-2 border-md-sys-color-outline px-4 py-3 outline-none focus:border-md-sys-color-primary transition-colors resize-none rounded-t-sm"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Model -->
                <div
                    class="bg-md-sys-color-surface-variant/30 rounded-t-lg border-b border-md-sys-color-outline px-4 py-2">
                    <label class="block text-xs text-md-sys-color-primary mb-1" data-i18n="sb.model">Model</label>
                    <select id="edit-model" name="model_id"
                        class="w-full bg-transparent outline-none text-md-sys-color-on-surface font-medium py-1">
                        <option value="doubao-seedance-1-5-pro-251215">Seedance 1.5 Pro</option>
                        <option value="doubao-seedance-1-0-pro-fast-251015">Seedance 1.0 Pro Fast</option>
                    </select>
                </div>
                <!-- Ratio -->
                <div
                    class="bg-md-sys-color-surface-variant/30 rounded-t-lg border-b border-md-sys-color-outline px-4 py-2">
                    <label class="block text-xs text-md-sys-color-primary mb-1" data-i18n="sb.ratio">Ratio</label>
                    <select id="edit-ratio" name="ratio"
                        class="w-full bg-transparent outline-none text-md-sys-color-on-surface font-medium py-1">
                        <option value="adaptive">Adaptive</option>
                        <option value="16:9">16:9</option>
                        <option value="9:16">9:16</option>
                    </select>
                </div>
                <!-- Duration -->
                <div
                    class="bg-md-sys-color-surface-variant/30 rounded-t-lg border-b border-md-sys-color-outline px-4 py-2">
                    <label class="block text-xs text-md-sys-color-primary mb-1" data-i18n="sb.duration">Duration</label>
                    <select id="edit-duration" name="duration"
                        class="w-full bg-transparent outline-none text-md-sys-color-on-surface font-medium py-1">
                        <option value="5">5s</option>
                        <option value="10">10s</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- First Frame -->
                <div>
                    <label class="block text-sm font-medium text-md-sys-color-on-surface-variant mb-2"
                        data-i18n="sb.first_frame">First Frame</label>
                    <input type="file" name="first_frame" accept="image/*"
                        class="w-full text-sm text-md-sys-color-on-surface file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-md-sys-color-primary-container file:text-md-sys-color-on-primary-container hover:file:bg-md-sys-color-primary/20">
                </div>
                <!-- Last Frame -->
                <div>
                    <label class="block text-sm font-medium text-md-sys-color-on-surface-variant mb-2"
                        data-i18n="sb.last_frame">Last Frame</label>
                    <input type="file" name="last_frame" accept="image/*"
                        class="w-full text-sm text-md-sys-color-on-surface file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-md-sys-color-primary-container file:text-md-sys-color-on-primary-container hover:file:bg-md-sys-color-primary/20">
                </div>
            </div>

            <div class="flex justify-end gap-2 pt-4">
                <button type="button" onclick="document.getElementById('edit-dialog').close()" class="md3-btn-text"
                    data-i18n="btn.cancel">Cancel</button>
                <button type="submit" class="md3-btn-filled" data-i18n="sb.update_btn">Update</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    // Open Edit Dialog with pre-populated values
    function openEditDialog(id, prompt, modelId, ratio, duration) {
        const dialog = document.getElementById('edit-dialog');
        const form = document.getElementById('edit-form');

        // Set form action
        form.action = `/storyboards/${id}/update`;

        // Populate fields
        document.getElementById('edit-prompt').value = prompt;
        document.getElementById('edit-model').value = modelId;
        document.getElementById('edit-ratio').value = ratio;
        document.getElementById('edit-duration').value = duration.toString();

        dialog.showModal();
    }

    // Drag and Drop functionality for image upload
    function setupDragDrop(dropZoneId, inputId) {
        const dropZone = document.getElementById(dropZoneId);
        const input = document.getElementById(inputId);
        if (!dropZone || !input) return;

        const placeholder = dropZone.querySelector('.upload-placeholder');
        const preview = dropZone.querySelector('.preview-img');

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // Highlight on drag
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('border-md-sys-color-primary', 'bg-md-sys-color-primary/10');
                dropZone.classList.remove('border-md-sys-color-outline');
            });
        });

        // Remove highlight on leave/drop
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('border-md-sys-color-primary', 'bg-md-sys-color-primary/10');
                dropZone.classList.add('border-md-sys-color-outline');
            });
        });

        // Handle drop
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                // Create a new DataTransfer to set files on input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                input.files = dataTransfer.files;
                showPreview(files[0], placeholder, preview);
            }
        });

        // Handle file selection via input
        input.addEventListener('change', () => {
            if (input.files.length > 0) {
                showPreview(input.files[0], placeholder, preview);
            }
        });
    }

    function showPreview(file, placeholder, preview) {
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }

    // Initialize drag-drop for both zones
    document.addEventListener('DOMContentLoaded', () => {
        setupDragDrop('drop-first-frame', 'input-first-frame');
        setupDragDrop('drop-last-frame', 'input-last-frame');
    });

    // Handle Generate Submit with AJAX to avoid reload
    document.querySelectorAll('.generate-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Submitting...';

            try {
                const resp = await fetch(form.action, { method: 'POST' });
                if (resp.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to start generation');
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        });
    });

    // Simple Polling for Running/Queued tasks
    const runningTasks = [
        {{ range .Project.Storyboards }}
        {{ if or (eq .Status "Running") (eq .Status "Queued") (eq .Status "running") (eq .Status "queued") }}{{ .ID }},{{ end }}
        {{ end }}
    ].filter(id => id != null);

    if (runningTasks.length > 0) {
        const interval = setInterval(async () => {
            let stillRunning = false;
            for (const id of runningTasks) {
                try {
                    const res = await fetch(`/storyboards/${id}/status`);
                    const data = await res.json();
                    const status = data.status?.toLowerCase();
                    if (status === 'succeeded' || status === 'failed') {
                        // Reload if any task finished
                        window.location.reload();
                        return;
                    }
                    if (status === 'running' || status === 'queued') {
                        stillRunning = true;
                    }
                } catch (e) {
                    console.error(e);
                }
            }
            if (!stillRunning) {
                clearInterval(interval);
            }
        }, 3000); // 3 seconds poll
    }
</script>

{{ template "footer" . }}